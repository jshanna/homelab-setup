---
- name: Check if istioctl is installed
  command: which istioctl
  register: istioctl_check
  failed_when: false
  changed_when: false

- name: Download istioctl
  get_url:
    url: "https://github.com/istio/istio/releases/download/{{ istio_version }}/istioctl-{{ istio_version }}-linux-amd64.tar.gz"
    dest: /tmp/istioctl.tar.gz
    mode: '0644'
  when: istioctl_check.rc != 0

- name: Extract istioctl
  unarchive:
    src: /tmp/istioctl.tar.gz
    dest: /usr/local/bin
    remote_src: yes
  when: istioctl_check.rc != 0

- name: Install Gateway API CRDs
  command: kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/{{ gateway_api_version }}/standard-install.yaml
  register: gateway_api_result
  changed_when: "'created' in gateway_api_result.stdout or 'configured' in gateway_api_result.stdout"

- name: Check if Istio is installed
  command: kubectl get namespace {{ istio_namespace }}
  register: istio_ns_check
  failed_when: false
  changed_when: false

- name: Install Istio with ambient profile
  command: istioctl install --set profile={{ istio_profile }} -y
  when: istio_ns_check.rc != 0
  register: istio_install_result

- name: Wait for Istio control plane to be ready
  command: >
    kubectl wait --namespace {{ istio_namespace }}
    --for=condition=ready pod
    --selector=app=istiod
    --timeout=300s
  changed_when: false

- name: Wait for ztunnel to be ready
  command: >
    kubectl wait --namespace {{ istio_namespace }}
    --for=condition=ready pod
    --selector=app=ztunnel
    --timeout=300s
  changed_when: false

- name: Create Istio ingress gateway
  command: kubectl apply -f -
  args:
    stdin: |
      apiVersion: gateway.networking.k8s.io/v1
      kind: Gateway
      metadata:
        name: homelab-gateway
        namespace: {{ istio_namespace }}
      spec:
        gatewayClassName: istio
        listeners:
          - name: http
            port: 80
            protocol: HTTP
            allowedRoutes:
              namespaces:
                from: All
  register: gateway_result
  changed_when: "'created' in gateway_result.stdout or 'configured' in gateway_result.stdout"

- name: Wait for gateway to get external IP
  command: >
    kubectl get gateway homelab-gateway -n {{ istio_namespace }}
    -o jsonpath='{.status.addresses[0].value}'
  register: gateway_ip
  until: gateway_ip.stdout != ""
  retries: 30
  delay: 10
  changed_when: false

- name: Display gateway IP
  debug:
    msg: "Istio Gateway IP: {{ gateway_ip.stdout }}"
