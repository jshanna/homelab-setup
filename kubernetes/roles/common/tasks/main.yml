---
# Common tasks for all Kubernetes nodes
# Aligned with: https://www.cherryservers.com/blog/install-kubernetes-ubuntu

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install required packages
  apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg
      - conntrack
      - socat
      - ipset
    state: present

# ===========================================
# Disable Swap
# ===========================================

- name: Disable swap
  command: swapoff -a
  when: disable_swap

- name: Remove swap from fstab
  lineinfile:
    path: /etc/fstab
    regexp: '.*swap.*'
    state: absent
  when: disable_swap

# ===========================================
# Kernel Modules
# ===========================================

- name: Load kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop: "{{ kernel_modules }}"

- name: Ensure kernel modules load on boot
  copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      {% for module in kernel_modules %}
      {{ module }}
      {% endfor %}

# ===========================================
# Sysctl Parameters
# ===========================================

- name: Set sysctl parameters
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/k8s.conf
    reload: yes
  loop: "{{ sysctl_params | dict2items }}"

# ===========================================
# Container Runtime (containerd via docker.io)
# ===========================================

- name: Install docker.io (includes containerd)
  apt:
    name: docker.io
    state: present
    update_cache: yes

- name: Enable and start Docker service
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Create containerd config directory
  file:
    path: /etc/containerd
    state: directory

- name: Generate default containerd config
  shell: containerd config default > /etc/containerd/config.toml
  args:
    creates: /etc/containerd/config.toml

- name: Configure containerd to use systemd cgroup
  replace:
    path: /etc/containerd/config.toml
    regexp: 'SystemdCgroup = false'
    replace: 'SystemdCgroup = true'
  notify: Restart containerd

- name: Flush handlers to restart containerd now
  meta: flush_handlers

- name: Enable and start containerd
  systemd:
    name: containerd
    state: started
    enabled: yes

- name: Wait for containerd socket
  wait_for:
    path: /var/run/containerd/containerd.sock
    state: present
    timeout: 30

# ===========================================
# Kubernetes Repository (modern GPG handling)
# ===========================================

- name: Create keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Download Kubernetes GPG key
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
  args:
    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

- name: Add Kubernetes repository
  copy:
    dest: /etc/apt/sources.list.d/kubernetes.list
    content: |
      deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kubernetes_version }}/deb/ /

- name: Update apt cache after adding Kubernetes repo
  apt:
    update_cache: yes

# ===========================================
# Kubernetes Packages
# ===========================================

- name: Install Kubernetes packages
  apt:
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present

- name: Hold Kubernetes packages
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  loop:
    - kubelet
    - kubeadm
    - kubectl

- name: Enable kubelet service
  systemd:
    name: kubelet
    enabled: yes
