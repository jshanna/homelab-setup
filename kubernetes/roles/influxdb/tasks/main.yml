---
- name: Validate InfluxDB admin token is set
  fail:
    msg: "influxdb_admin_token must be set in group_vars/all.yml. Do not use 'admin', 'changeme', or empty."
  when: influxdb_admin_token is not defined or influxdb_admin_token == "" or influxdb_admin_token == "changeme" or influxdb_admin_token == "admin"

# ===========================================
# Migration: Remove InfluxDB 2.x if present
# ===========================================

- name: Check if InfluxDB 2.x release exists
  command: helm status influxdb2 -n {{ influxdb_namespace }}
  register: influxdb2_status
  failed_when: false
  changed_when: false

- name: Remove old InfluxDB 2.x ServiceMonitor
  command: kubectl delete servicemonitor influxdb2 -n {{ influxdb_namespace }}
  when: influxdb2_status.rc == 0
  failed_when: false

- name: Uninstall InfluxDB 2.x release
  command: helm uninstall influxdb2 -n {{ influxdb_namespace }}
  when: influxdb2_status.rc == 0

- name: Delete old InfluxDB 2.x PVC
  command: kubectl delete pvc influxdb2 -n {{ influxdb_namespace }}
  when: influxdb2_status.rc == 0
  failed_when: false

- name: Remove old InfluxDB 2.x values file
  file:
    path: /tmp/influxdb-values.yaml
    state: absent

# ===========================================
# Install InfluxDB 3 Core via Bitnami
# ===========================================

- name: Create databases namespace
  command: kubectl create namespace {{ influxdb_namespace }}
  register: ns_result
  changed_when: "'created' in ns_result.stdout"
  failed_when: "ns_result.rc != 0 and 'already exists' not in ns_result.stderr"

- name: Create InfluxDB 3 values file
  copy:
    dest: /tmp/influxdb3-values.yaml
    content: |
      auth:
        enabled: true
        admin:
          token: "{{ influxdb_admin_token }}"
      persistence:
        enabled: true
        size: {{ influxdb_storage_size }}
      service:
        type: ClusterIP
        ports:
          http: 8181
      resources:
        requests:
          memory: 256Mi
          cpu: 100m
        limits:
          memory: 1Gi
      metrics:
        enabled: {{ influxdb_metrics_enabled | lower }}
        serviceMonitor:
          enabled: {{ influxdb_metrics_enabled | lower }}

- name: Install/upgrade InfluxDB 3 Core
  command: >
    helm upgrade -i influxdb oci://registry-1.docker.io/bitnamicharts/influxdb
    --namespace {{ influxdb_namespace }}
    {{ '--version ' + influxdb_chart_version if influxdb_chart_version else '' }}
    --values /tmp/influxdb3-values.yaml
    --wait --timeout 10m

- name: Wait for InfluxDB to be ready
  command: >
    kubectl wait --namespace {{ influxdb_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/name=influxdb
    --timeout=300s
  changed_when: false

- name: Display InfluxDB deployment info
  debug:
    msg:
      - "InfluxDB 3 Core deployed successfully"
      - "Namespace: {{ influxdb_namespace }}"
      - "API Port: 8181"
      - "Access via: http://{{ influxdb_hostname }} (after ingress setup)"
      - "Note: Use bearer token authentication with your configured token"
