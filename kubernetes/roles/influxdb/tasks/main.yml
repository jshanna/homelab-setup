---
# Note: influxdb_admin_token is no longer user-provided.
# InfluxDB 3 generates tokens via CLI - we create it after startup.

- name: Validate InfluxDB Explorer session secret is set
  fail:
    msg: "influxdb_explorer_session_secret must be set in group_vars/all.yml. Do not use default values."
  when: influxdb_explorer_session_secret is not defined or influxdb_explorer_session_secret == "" or influxdb_explorer_session_secret == "change-me-to-random-hex" or influxdb_explorer_session_secret == "explorer_session"

# ===========================================
# Migration: Remove old InfluxDB deployments
# ===========================================

- name: Check if InfluxDB 2.x Helm release exists
  command: helm status influxdb2 -n {{ influxdb_namespace }}
  register: influxdb2_status
  failed_when: false
  changed_when: false

- name: Uninstall InfluxDB 2.x Helm release
  command: helm uninstall influxdb2 -n {{ influxdb_namespace }}
  when: influxdb2_status.rc == 0

- name: Check if Bitnami InfluxDB Helm release exists
  command: helm status influxdb -n {{ influxdb_namespace }}
  register: influxdb_helm_status
  failed_when: false
  changed_when: false

- name: Uninstall Bitnami InfluxDB Helm release
  command: helm uninstall influxdb -n {{ influxdb_namespace }}
  when: influxdb_helm_status.rc == 0

- name: Delete old InfluxDB PVCs
  command: kubectl delete pvc {{ item }} -n {{ influxdb_namespace }}
  loop:
    - influxdb2
    - influxdb
  failed_when: false

- name: Delete old ServiceMonitors
  command: kubectl delete servicemonitor {{ item }} -n {{ influxdb_namespace }}
  loop:
    - influxdb2
    - influxdb
  failed_when: false

- name: Remove old values files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/influxdb-values.yaml
    - /tmp/influxdb3-values.yaml

# ===========================================
# Deploy InfluxDB 3 Core (official image)
# ===========================================

- name: Create databases namespace
  command: kubectl create namespace {{ influxdb_namespace }}
  register: ns_result
  changed_when: "'created' in ns_result.stdout"
  failed_when: "ns_result.rc != 0 and 'already exists' not in ns_result.stderr"

- name: Deploy InfluxDB 3 Core
  command: kubectl apply -f -
  args:
    stdin: |
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: influxdb-data
        namespace: {{ influxdb_namespace }}
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: {{ influxdb_storage_size }}
      ---
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: influxdb
        namespace: {{ influxdb_namespace }}
        labels:
          app.kubernetes.io/name: influxdb
          app.kubernetes.io/component: database
      spec:
        replicas: 1
        selector:
          matchLabels:
            app.kubernetes.io/name: influxdb
        template:
          metadata:
            labels:
              app.kubernetes.io/name: influxdb
          spec:
            containers:
              - name: influxdb
                image: influxdb:3-core
                args:
                  - influxdb3
                  - serve
                  - --node-id=node-0
                  - --object-store=file
                  - --data-dir=/var/lib/influxdb3/data
                  - --disable-authz=health,ping,metrics
                ports:
                  - containerPort: 8181
                    name: http
                resources:
                  requests:
                    memory: 256Mi
                    cpu: 100m
                  limits:
                    memory: 1Gi
                volumeMounts:
                  - name: data
                    mountPath: /var/lib/influxdb3/data
                livenessProbe:
                  httpGet:
                    path: /health
                    port: 8181
                  initialDelaySeconds: 30
                  periodSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /health
                    port: 8181
                  initialDelaySeconds: 5
                  periodSeconds: 5
            volumes:
              - name: data
                persistentVolumeClaim:
                  claimName: influxdb-data
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: influxdb
        namespace: {{ influxdb_namespace }}
        labels:
          app.kubernetes.io/name: influxdb
      spec:
        type: ClusterIP
        ports:
          - port: 8181
            targetPort: 8181
            name: http
        selector:
          app.kubernetes.io/name: influxdb
  register: influxdb_deploy
  changed_when: "'created' in influxdb_deploy.stdout or 'configured' in influxdb_deploy.stdout"

- name: Wait for InfluxDB to be ready
  command: >
    kubectl wait --namespace {{ influxdb_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/name=influxdb
    --timeout=300s
  changed_when: false

# ===========================================
# Generate admin token (InfluxDB 3 requires CLI token generation)
# ===========================================

- name: Check if admin token already exists in secret
  command: >
    kubectl get secret influxdb-auth -n {{ influxdb_namespace }}
    -o jsonpath='{.data.admin-token}'
  register: existing_token_check
  failed_when: false
  changed_when: false

- name: Set token generation flag
  set_fact:
    need_influxdb_token: "{{ existing_token_check.rc != 0 or existing_token_check.stdout == '' }}"

- name: Create InfluxDB admin token
  command: >
    kubectl exec -n {{ influxdb_namespace }} deploy/influxdb --
    influxdb3 create token --admin
  register: influxdb_token_output
  failed_when: false
  when: need_influxdb_token | bool

- name: Debug token output
  debug:
    msg:
      - "stdout: {{ influxdb_token_output.stdout | default('') }}"
      - "stderr: {{ influxdb_token_output.stderr | default('') }}"
      - "rc: {{ influxdb_token_output.rc | default('') }}"
  when:
    - need_influxdb_token | bool

- name: Check if token already exists in InfluxDB
  set_fact:
    influxdb_token_already_exists: "{{ 'already exists' in (influxdb_token_output.stdout | default('')) }}"
  when: need_influxdb_token | bool

- name: Fail if token exists but secret is missing
  fail:
    msg: |
      InfluxDB already has an admin token created, but the secret is missing.
      This can happen if a previous deployment was interrupted.

      To fix this, you need to reset the InfluxDB data:
        kubectl delete pvc influxdb-data -n {{ influxdb_namespace }}
        kubectl delete pod -l app.kubernetes.io/name=influxdb -n {{ influxdb_namespace }}

      Then re-run the playbook.
  when:
    - need_influxdb_token | bool
    - influxdb_token_already_exists | default(false) | bool

- name: Extract token from output
  set_fact:
    influxdb_admin_token: "{{ influxdb_token_output.stdout | trim }}"
  when:
    - need_influxdb_token | bool
    - influxdb_token_output.rc == 0
    - influxdb_token_output.stdout is defined
    - influxdb_token_output.stdout | trim | length > 0

- name: Delete existing auth secret if regenerating
  command: kubectl delete secret influxdb-auth -n {{ influxdb_namespace }}
  failed_when: false
  when:
    - need_influxdb_token | bool
    - influxdb_admin_token is defined

- name: Create secret with admin token
  shell: >
    kubectl create secret generic influxdb-auth
    -n {{ influxdb_namespace }}
    --from-literal=admin-token='{{ influxdb_admin_token }}'
  when:
    - need_influxdb_token | bool
    - influxdb_admin_token is defined

- name: Display new admin token
  debug:
    msg:
      - "=========================================="
      - "NEW INFLUXDB ADMIN TOKEN CREATED"
      - "=========================================="
      - "Token: {{ influxdb_admin_token }}"
      - ""
      - "IMPORTANT: Save this token! It cannot be retrieved later."
      - "Use this token in InfluxDB Explorer to connect."
      - "=========================================="
  when:
    - need_influxdb_token | bool
    - influxdb_admin_token is defined

- name: Get existing token from secret
  shell: >
    kubectl get secret influxdb-auth -n {{ influxdb_namespace }}
    -o jsonpath='{.data.admin-token}' | base64 -d
  register: existing_token
  changed_when: false
  when: not (need_influxdb_token | bool)

- name: Display existing token info
  debug:
    msg: "InfluxDB admin token already exists. Retrieve with: kubectl get secret influxdb-auth -n {{ influxdb_namespace }} -o jsonpath='{.data.admin-token}' | base64 -d"
  when: not (need_influxdb_token | bool)

# ===========================================
# Prometheus monitoring (ServiceMonitor)
# ===========================================

- name: Create ServiceMonitor for InfluxDB
  command: kubectl apply -f -
  args:
    stdin: |
      apiVersion: monitoring.coreos.com/v1
      kind: ServiceMonitor
      metadata:
        name: influxdb
        namespace: {{ influxdb_namespace }}
        labels:
          app.kubernetes.io/name: influxdb
      spec:
        selector:
          matchLabels:
            app.kubernetes.io/name: influxdb
        namespaceSelector:
          matchNames:
            - {{ influxdb_namespace }}
        endpoints:
          - port: http
            interval: 30s
            path: /metrics
  register: influxdb_monitor
  changed_when: "'created' in influxdb_monitor.stdout or 'configured' in influxdb_monitor.stdout"
  when: influxdb_metrics_enabled | default(true)

# ===========================================
# Deploy InfluxDB 3 Explorer (Web UI)
# ===========================================

- name: Deploy InfluxDB 3 Explorer
  command: kubectl apply -f -
  args:
    stdin: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: influxdb-explorer
        namespace: {{ influxdb_namespace }}
      type: Opaque
      stringData:
        session-secret: "{{ influxdb_explorer_session_secret }}"
      ---
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: influxdb-explorer
        namespace: {{ influxdb_namespace }}
        labels:
          app.kubernetes.io/name: influxdb-explorer
      spec:
        replicas: 1
        selector:
          matchLabels:
            app.kubernetes.io/name: influxdb-explorer
        template:
          metadata:
            labels:
              app.kubernetes.io/name: influxdb-explorer
          spec:
            containers:
              - name: influxdb-explorer
                image: influxdata/influxdb3-ui:latest
                args: ["--mode=admin"]
                ports:
                  - containerPort: 80
                    name: http
                env:
                  - name: SESSION_SECRET_KEY
                    valueFrom:
                      secretKeyRef:
                        name: influxdb-explorer
                        key: session-secret
                resources:
                  requests:
                    memory: 128Mi
                    cpu: 50m
                  limits:
                    memory: 512Mi
      ---
      apiVersion: v1
      kind: Service
      metadata:
        name: influxdb-explorer
        namespace: {{ influxdb_namespace }}
        labels:
          app.kubernetes.io/name: influxdb-explorer
      spec:
        type: ClusterIP
        ports:
          - port: 80
            targetPort: 80
            name: http
        selector:
          app.kubernetes.io/name: influxdb-explorer
  register: influxdb_explorer_deploy
  changed_when: "'created' in influxdb_explorer_deploy.stdout or 'configured' in influxdb_explorer_deploy.stdout"

- name: Wait for InfluxDB Explorer to be ready
  command: >
    kubectl wait --namespace {{ influxdb_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/name=influxdb-explorer
    --timeout=120s
  changed_when: false

- name: Display InfluxDB deployment info
  debug:
    msg:
      - "InfluxDB 3 Core deployed successfully"
      - "Namespace: {{ influxdb_namespace }}"
      - "Image: influxdb:3-core (official)"
      - "API Port: 8181"
      - "Access via: http://{{ influxdb_hostname }} (after ingress setup)"
      - ""
      - "InfluxDB 3 Explorer (Web UI) deployed"
      - "Access via: http://{{ influxdb_explorer_hostname }} (after ingress setup)"
      - ""
      - "To get admin token: kubectl get secret influxdb-auth -n {{ influxdb_namespace }} -o jsonpath='{.data.admin-token}' | base64 -d"
      - "Use this token in Explorer to connect to: http://influxdb:8181"
