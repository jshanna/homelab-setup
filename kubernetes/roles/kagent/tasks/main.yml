---
- name: Check for Gemini API key
  fail:
    msg: "GEMINI_API_KEY environment variable must be set"
  when: kagent_provider == "gemini" and (gemini_api_key is not defined or gemini_api_key == "")

- name: Create kagent namespace
  command: kubectl create namespace {{ kagent_namespace }}
  register: ns_result
  changed_when: "'created' in ns_result.stdout"
  failed_when: "ns_result.rc != 0 and 'already exists' not in ns_result.stderr"

- name: Install/upgrade kagent CRDs
  command: >
    helm upgrade -i kagent-crds oci://ghcr.io/kagent-dev/kagent/helm/kagent-crds
    --namespace {{ kagent_namespace }}

- name: Install/upgrade kagent with Gemini provider
  command: >
    helm upgrade -i kagent oci://ghcr.io/kagent-dev/kagent/helm/kagent
    --namespace {{ kagent_namespace }}
    --set providers.default=gemini
    --set providers.gemini.apiKey={{ gemini_api_key }}
    --set grafana-mcp.config.GRAFANA_URL={{ grafana_url }}
    --wait --timeout 5m
  when: kagent_provider == "gemini"

- name: Wait for kagent controller to be ready
  command: >
    kubectl wait --namespace {{ kagent_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/name=kagent
    --timeout=300s
  changed_when: false
  register: kagent_controller_wait
  retries: 2
  delay: 30
  until: kagent_controller_wait.rc == 0

- name: Wait for kagent UI to be ready
  command: >
    kubectl wait --namespace {{ kagent_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/component=ui
    --timeout=300s
  changed_when: false
  register: kagent_ui_wait
  retries: 2
  delay: 30
  until: kagent_ui_wait.rc == 0

# ===========================================
# Configure kagent-grafana-mcp
# ===========================================

- name: Wait for kagent-grafana-mcp to be ready
  command: >
    kubectl wait --namespace {{ kagent_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/name=kagent-grafana-mcp
    --timeout=300s
  changed_when: false
  failed_when: false
  register: grafana_mcp_wait

- name: Check if kagent-grafana-mcp secret has valid token
  shell: >
    kubectl get secret -n {{ kagent_namespace }} kagent-grafana-mcp
    -o jsonpath='{.data.GRAFANA_SERVICE_ACCOUNT_TOKEN}' 2>/dev/null | base64 -d
  register: existing_grafana_token
  changed_when: false
  failed_when: false
  when: grafana_mcp_wait.rc == 0

- name: Set token generation flag
  set_fact:
    need_grafana_token: "{{ existing_grafana_token.stdout | default('') | length < 10 }}"
  when: grafana_mcp_wait.rc == 0

- name: Debug token generation flag
  debug:
    msg: "need_grafana_token: {{ need_grafana_token }}, existing token length: {{ existing_grafana_token.stdout | default('') | length }}"
  when: grafana_mcp_wait.rc == 0

- name: Get Grafana admin password
  shell: >
    kubectl get secret -n {{ monitoring_namespace }} {{ grafana_service }}
    -o jsonpath='{.data.admin-password}' | base64 -d
  register: grafana_admin_password
  changed_when: false
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool

- name: Get Grafana ClusterIP
  shell: >
    kubectl get svc -n {{ monitoring_namespace }} {{ grafana_service }}
    -o jsonpath='{.spec.clusterIP}'
  register: grafana_cluster_ip
  changed_when: false
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool

- name: Set Grafana API URL
  set_fact:
    grafana_api_url: "http://{{ grafana_cluster_ip.stdout }}"
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool

- name: Check if kagent service account exists in Grafana
  uri:
    url: "{{ grafana_api_url }}/api/serviceaccounts/search?query=kagent"
    method: GET
    user: admin
    password: "{{ grafana_admin_password.stdout }}"
    force_basic_auth: true
    status_code: [200]
  register: grafana_sa_check
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool

- name: Create Grafana service account for kagent
  uri:
    url: "{{ grafana_api_url }}/api/serviceaccounts"
    method: POST
    user: admin
    password: "{{ grafana_admin_password.stdout }}"
    force_basic_auth: true
    body_format: json
    body:
      name: kagent
      role: Admin
    status_code: [200, 201, 409]
  register: grafana_sa_create
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool
    - grafana_sa_check.json.serviceAccounts | length == 0

- name: Get kagent service account ID
  uri:
    url: "{{ grafana_api_url }}/api/serviceaccounts/search?query=kagent"
    method: GET
    user: admin
    password: "{{ grafana_admin_password.stdout }}"
    force_basic_auth: true
    status_code: [200]
  register: grafana_sa_info
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool

- name: Set service account ID
  set_fact:
    kagent_sa_id: "{{ grafana_sa_info.json.serviceAccounts[0].id }}"
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool
    - grafana_sa_info.json.serviceAccounts | length > 0

- name: Get existing tokens for kagent service account
  uri:
    url: "{{ grafana_api_url }}/api/serviceaccounts/{{ kagent_sa_id }}/tokens"
    method: GET
    user: admin
    password: "{{ grafana_admin_password.stdout }}"
    force_basic_auth: true
    status_code: [200]
  register: existing_tokens
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool
    - kagent_sa_id is defined

- name: Delete existing tokens for kagent service account
  uri:
    url: "{{ grafana_api_url }}/api/serviceaccounts/{{ kagent_sa_id }}/tokens/{{ item.id }}"
    method: DELETE
    user: admin
    password: "{{ grafana_admin_password.stdout }}"
    force_basic_auth: true
    status_code: [200, 404]
  loop: "{{ existing_tokens.json | default([]) }}"
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool
    - kagent_sa_id is defined
    - existing_tokens.json | length > 0

- name: Create Grafana service account token
  uri:
    url: "{{ grafana_api_url }}/api/serviceaccounts/{{ kagent_sa_id }}/tokens"
    method: POST
    user: admin
    password: "{{ grafana_admin_password.stdout }}"
    force_basic_auth: true
    body_format: json
    body:
      name: "kagent-mcp"
    status_code: [200, 201]
  register: grafana_token_create
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool
    - kagent_sa_id is defined

- name: Set Grafana token fact
  set_fact:
    kagent_grafana_token: "{{ grafana_token_create.json.key }}"
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | bool
    - grafana_token_create.json.key is defined

- name: Patch kagent-grafana-mcp Secret with token
  shell: |
    kubectl patch secret kagent-grafana-mcp -n {{ kagent_namespace }} \
      --type=merge -p '{"stringData":{"GRAFANA_SERVICE_ACCOUNT_TOKEN":"{{ kagent_grafana_token }}"}}'
  when:
    - grafana_mcp_wait.rc == 0
    - kagent_grafana_token is defined

- name: Restart kagent-grafana-mcp deployment
  command: kubectl rollout restart deployment kagent-grafana-mcp -n {{ kagent_namespace }}
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | default(false) | bool

- name: Wait for kagent-grafana-mcp restart to complete
  command: >
    kubectl rollout status deployment kagent-grafana-mcp -n {{ kagent_namespace }} --timeout=120s
  when:
    - grafana_mcp_wait.rc == 0
    - need_grafana_token | default(false) | bool
  changed_when: false
