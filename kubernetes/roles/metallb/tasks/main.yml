---
- name: Add MetalLB Helm repository
  command: helm repo add metallb https://metallb.github.io/metallb
  register: helm_repo_result
  changed_when: "'has been added' in helm_repo_result.stdout"
  failed_when: false

- name: Update Helm repositories
  command: helm repo update
  changed_when: false

- name: Create MetalLB namespace
  command: kubectl create namespace {{ metallb_namespace }}
  register: ns_result
  changed_when: "'created' in ns_result.stdout"
  failed_when: "ns_result.rc != 0 and 'already exists' not in ns_result.stderr"

- name: Install/upgrade MetalLB with Helm
  command: >
    helm upgrade -i metallb metallb/metallb
    --namespace {{ metallb_namespace }}
    --version {{ metallb_version }}
    --wait

- name: Wait for MetalLB controller to be ready
  command: >
    kubectl wait --namespace {{ metallb_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/component=controller
    --timeout=120s
  changed_when: false

- name: Apply MetalLB IP address pool
  command: kubectl apply -f -
  args:
    stdin: |
      apiVersion: metallb.io/v1beta1
      kind: IPAddressPool
      metadata:
        name: {{ metallb_pool_name }}
        namespace: {{ metallb_namespace }}
      spec:
        addresses:
          - {{ metallb_ip_range }}
  register: pool_result
  changed_when: "'created' in pool_result.stdout or 'configured' in pool_result.stdout"

- name: Apply MetalLB L2 advertisement
  command: kubectl apply -f -
  args:
    stdin: |
      apiVersion: metallb.io/v1beta1
      kind: L2Advertisement
      metadata:
        name: homelab-l2
        namespace: {{ metallb_namespace }}
      spec:
        ipAddressPools:
          - {{ metallb_pool_name }}
  register: l2_result
  changed_when: "'created' in l2_result.stdout or 'configured' in l2_result.stdout"
