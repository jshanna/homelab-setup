---
# Control plane initialization
# Aligned with: https://www.cherryservers.com/blog/install-kubernetes-ubuntu

- name: Check if cluster is already initialized
  stat:
    path: /etc/kubernetes/admin.conf
  register: kubeadm_init

- name: Initialize Kubernetes control plane
  command: >
    kubeadm init
    --pod-network-cidr={{ pod_network_cidr }}
    --service-cidr={{ service_cidr }}
  when: not kubeadm_init.stat.exists
  register: kubeadm_init_result

# ===========================================
# Setup kubeconfig for root user
# ===========================================

- name: Create .kube directory for root
  file:
    path: /root/.kube
    state: directory
    mode: '0755'

- name: Copy admin.conf to root's .kube directory
  copy:
    src: "{{ kubeconfig_path }}"
    dest: /root/.kube/config
    remote_src: yes
    mode: '0600'

# ===========================================
# Setup kubeconfig for ansible user
# ===========================================

- name: Create .kube directory for ansible user
  file:
    path: /home/ansible/.kube
    state: directory
    owner: ansible
    group: ansible
    mode: '0755'

- name: Copy admin.conf to ansible user's .kube directory
  copy:
    src: "{{ kubeconfig_path }}"
    dest: /home/ansible/.kube/config
    remote_src: yes
    owner: ansible
    group: ansible
    mode: '0600'

# ===========================================
# Install Calico CNI via Tigera Operator
# ===========================================

- name: Install Tigera operator
  command: kubectl create -f {{ tigera_operator_url }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  when: cni_plugin == "calico" and kubeadm_init_result is changed
  register: tigera_result
  failed_when: tigera_result.rc != 0 and 'already exists' not in tigera_result.stderr

- name: Download Calico custom resources
  get_url:
    url: "{{ calico_custom_resources_url }}"
    dest: /tmp/calico-custom-resources.yaml
    mode: '0644'
  when: cni_plugin == "calico" and kubeadm_init_result is changed

- name: Update pod network CIDR in custom resources
  replace:
    path: /tmp/calico-custom-resources.yaml
    regexp: 'cidr: 192\.168\.0\.0/16'
    replace: 'cidr: {{ pod_network_cidr }}'
  when: cni_plugin == "calico" and kubeadm_init_result is changed

- name: Apply Calico custom resources
  command: kubectl create -f /tmp/calico-custom-resources.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  when: cni_plugin == "calico" and kubeadm_init_result is changed
  register: calico_cr_result
  failed_when: calico_cr_result.rc != 0 and 'already exists' not in calico_cr_result.stderr

- name: Wait for Calico pods to be ready
  command: >
    kubectl wait --namespace calico-system
    --for=condition=ready pod
    --selector=k8s-app=calico-node
    --timeout=300s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  when: cni_plugin == "calico" and kubeadm_init_result is changed
  retries: 3
  delay: 30
  register: calico_wait
  until: calico_wait.rc == 0

# ===========================================
# Wait for control plane
# ===========================================

- name: Wait for control plane to be ready
  command: kubectl get nodes
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: nodes_result
  until: "'Ready' in nodes_result.stdout"
  retries: 30
  delay: 10
  when: kubeadm_init_result is changed

# ===========================================
# Generate join command for workers
# ===========================================

- name: Generate join command
  command: kubeadm token create --print-join-command
  register: join_command_result
  changed_when: false

- name: Store join command
  set_fact:
    kubeadm_join_command: "{{ join_command_result.stdout }}"

- name: Save join command to local file
  copy:
    content: "{{ kubeadm_join_command }}"
    dest: /tmp/kubeadm_join_command
    mode: '0600'
  delegate_to: localhost
  become: false

# ===========================================
# Install local-path-provisioner for storage
# ===========================================

- name: Install local-path-provisioner for persistent storage
  command: kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.30/deploy/local-path-storage.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: local_path_result
  changed_when: "'created' in local_path_result.stdout or 'configured' in local_path_result.stdout"

- name: Set local-path as default StorageClass
  command: >
    kubectl patch storageclass local-path
    -p '{"metadata": {"annotations":{"storageclass.kubernetes.io/is-default-class":"true"}}}'
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  changed_when: false
