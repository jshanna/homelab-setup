---
- name: Validate Grafana admin password is set
  fail:
    msg: "grafana_admin_password must be set in group_vars/all.yml (do not use default 'changeme')"
  when: grafana_admin_password is not defined or grafana_admin_password == "" or grafana_admin_password == "changeme"

- name: Add Prometheus Community Helm repository
  command: helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
  register: helm_repo_result
  changed_when: "'has been added' in helm_repo_result.stdout"
  failed_when: false

- name: Update Helm repositories
  command: helm repo update
  changed_when: false

- name: Create monitoring namespace
  command: kubectl create namespace {{ prometheus_namespace }}
  register: ns_result
  changed_when: "'created' in ns_result.stdout"
  failed_when: "ns_result.rc != 0 and 'already exists' not in ns_result.stderr"

- name: Create Prometheus values file
  copy:
    dest: /tmp/prometheus-values.yaml
    content: |
      grafana:
        adminPassword: "{{ grafana_admin_password }}"
        service:
          type: ClusterIP
        grafana.ini:
          users:
            allow_sign_up: false
      prometheus:
        prometheusSpec:
          retention: {{ prometheus_retention }}
          storageSpec:
            volumeClaimTemplate:
              spec:
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: {{ prometheus_storage_size }}
          podMonitorSelectorNilUsesHelmValues: false
          serviceMonitorSelectorNilUsesHelmValues: false
      alertmanager:
        alertmanagerSpec:
          storage:
            volumeClaimTemplate:
              spec:
                accessModes: ["ReadWriteOnce"]
                resources:
                  requests:
                    storage: 10Gi

- name: Install/upgrade kube-prometheus-stack
  command: >
    helm upgrade -i kube-prometheus-stack prometheus-community/kube-prometheus-stack
    --namespace {{ prometheus_namespace }}
    --version {{ prometheus_stack_version }}
    --values /tmp/prometheus-values.yaml
    --wait --timeout 10m

- name: Wait for Prometheus to be ready
  command: >
    kubectl wait --namespace {{ prometheus_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/name=prometheus
    --timeout=300s
  changed_when: false

- name: Wait for Grafana to be ready
  command: >
    kubectl wait --namespace {{ prometheus_namespace }}
    --for=condition=ready pod
    --selector=app.kubernetes.io/name=grafana
    --timeout=300s
  changed_when: false

# ===========================================
# Istio monitoring (ServiceMonitor/PodMonitor)
# ===========================================

- name: Create ServiceMonitor for istiod
  command: kubectl apply -f -
  args:
    stdin: |
      apiVersion: monitoring.coreos.com/v1
      kind: ServiceMonitor
      metadata:
        name: istiod
        namespace: istio-system
        labels:
          app: istiod
      spec:
        selector:
          matchLabels:
            app: istiod
        namespaceSelector:
          matchNames:
            - istio-system
        endpoints:
          - port: http-monitoring
            interval: 30s
            path: /metrics
  register: istiod_monitor
  changed_when: "'created' in istiod_monitor.stdout or 'configured' in istiod_monitor.stdout"

- name: Create PodMonitor for ztunnel (ambient mode)
  command: kubectl apply -f -
  args:
    stdin: |
      apiVersion: monitoring.coreos.com/v1
      kind: PodMonitor
      metadata:
        name: ztunnel
        namespace: istio-system
        labels:
          app: ztunnel
      spec:
        selector:
          matchLabels:
            app: ztunnel
        namespaceSelector:
          matchNames:
            - istio-system
        podMetricsEndpoints:
          - port: ztunnel-stats
            interval: 30s
            path: /metrics
  register: ztunnel_monitor
  changed_when: "'created' in ztunnel_monitor.stdout or 'configured' in ztunnel_monitor.stdout"
